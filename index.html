<meta charset=utf-8>
<script>
function SVG(width, height){
  this.width=width;
  this.height=height;
  this.content='';
  this.lineWidth=1;
  this.trans={x:0,y:0,w:1,h:1};
}
SVG.prototype={
  toDataURL: function(){
    var attributes = {
      width: this.width+'mm',
      height: this.height+'mm',
      viewBox: [0,0,this.width,this.height].join(' '),
      'stroke-width': this.lineWidth
    }
    var attrArray=[];
    for(var key in attributes){
      attrArray.push(key+'="'+attributes[key]+'"');
    }
    var data="<svg xmlns='http://www.w3.org/2000/svg' "+attrArray.join(' ')+">"+this.content+"</svg>"
    return 'data:image/svg+xml,'+encodeURIComponent(data);
  },
  translate: function(p){
    return {x:this.trans.x+p.x*this.trans.w,y:this.trans.y+p.y*this.trans.h}
  },
  transPoints: function(points){
    var self=this;
    return points.map(function(p){return self.translate(p)});
  },
  line: function(points, loop){
    points=this.transPoints(points);
    var out = [['M',points[0].x,points[0].y].join(' ')]
    for(var i=1;i<points.length;i++){
      var p=points[i];
      out.push('L'+[p.x,p.y].join(' '));
    }
    this.content+="<path stroke='black' fill='none' d='"+out.join(' ')+(loop?'z':'')+"' />";
  },
  curve: function(points, loop){
    points=this.transPoints(points);
    if(points.length>2){
      for(var i=0;i<points.length;i++){
        var p=points[i],pa=points[i-1],pb=points[i+1];
        if(loop&&!pa)pa=points[points.length-1];
        if(loop&&!pb)pb=points[0];
        if(!pa){
          pp=points[2];
          pa={x:3*p.x-3*pb.x+pp.x,y:3*p.y-3*pb.y+pp.y}
        }
        if(!pb){
          pp=points[points.length-3];
          pb={x:3*p.x-3*pa.x+pp.x,y:3*p.y-3*pa.y+pp.y}
        }
        var dx=pb.x-pa.x,dy=pb.y-pa.y;
        var l=Math.sqrt(dx*dx+dy*dy);
        p.dx=dx/l,p.dy=dy/l;
      }
    }
    var out = [['M',points[0].x,points[0].y].join(' ')]
    for(var i=1;i<=points.length;i++){
      var p1=points[i-1],p2=points[i];
      if(!p2){
        if(!loop)continue;
        p2=points[0];
      }
      var dx = p2.x-p1.x,dy=p2.y-p1.y;
      var l = Math.sqrt(dx*dx+dy*dy);
      out.push(
        'C'+[
          p1.x+l*(p1.dx||0)/3,
          p1.y+l*(p1.dy||0)/3,
          p2.x-l*(p2.dx||0)/3,
          p2.y-l*(p2.dy||0)/3,
          p2.x,p2.y
        ].join(' ')
      )
    }
    this.content+="<path stroke='black' fill='none' d='"+out.join(' ')+(loop?'z':'')+"' />"
  }
}

var defaultThickness=3.0
var defaultLazerWidth=0.1;
onload=function(){
  var thickness=parseFloat()||defaultThickness;
  var lazerWidth=parseFloat()||defaultLazerWidth;
  generate(thickness, lazerWidth);
}

function regenerate(){
  function getf(name, defval){
    return parseFloat(prompt(name, defval))||defval;
  }
  var img=document.querySelector('img');
  img.parentNode.removeChild(img)
  var thickness=getf('Thickness',defaultThickness)
  var lazerWidth=getf('LazerWidth',defaultLazerWidth);
  generate(thickness, lazerWidth);
}
function solveGradH(){
  function f(h){
    var tan1=Math.tan(1*Math.PI/5)
    var tan2=Math.tan(2*Math.PI/5)
    var hr=Math.sqrt(1+h*h)
    return Math.PI-Math.atan(tan1/hr)+Math.atan(tan2/hr)-Math.PI*6/5
  }
  //f(0)=>0 f(2)=>0
}


function generate(thickness, lazerWidth){
  var T=thickness;
  scale=1
  var size=20;
  var svg=new SVG(size*7.3,size*7.3);
  svg.trans={x:svg.width/3,y:svg.height/2,w:1,h:1};
  svg.lineWidth=lazerWidth||0.1;
  document.querySelector('span').textContent='Thickness='+T+' LazerWidth='+svg.lineWidth;

  function f(th,h){
    var tan1=Math.tan(th)
    var tan2=Math.tan(Math.PI-(Math.PI*6/5-th))
    var hr=Math.sqrt(1+h*h)
    var t1=Math.atan(tan1*hr)
    var t2=Math.PI-Math.atan(tan2*hr)
    return {t1: t1, t2: t2, diff: t1+t2-Math.PI*6/5}
  }
  function solve(h,a,b){
    var va=f(a,h).diff
    var vb=f(b,h).diff
    while(true){
      var middle = (a+b)/2
      var mv=f(middle,h).diff
      if(mv==0)return middle;
      if(middle<=a||middle>=b)return middle
      if(va*mv>0){a=middle}
      else{b=middle}
    }
  }
  var h=1
  console.error(solved=solve(h,0.001,Math.PI))
  var val=f(solved,h)
  var innerTOA=solved
  var innerTOB=Math.PI*6/5-solved
  var outerTOA=val.t1
  var outerTOB=val.t2
  console.error(f(solved,h).t1/Math.PI,f(solved,h).t2/Math.PI)

  var len=size/5
  var inner=len/2,outer=len*4/3
  edge(len,outerTOA,inner,outer)
  edge(len*0,outerTOA,inner,outer*4)
  edge(len,innerTOA,inner,outer)

console.error(innerTOA*180/Math.PI,innerTOB*180/Math.PI)
  var veca=[h*Math.sin(innerTOA),h*Math.cos(innerTOA),1]
  var vecb=[h*Math.sin(innerTOB),h*Math.cos(innerTOB),1]
  console.error(
    'a',
    180/Math.PI*Math.acos((veca[0]*veca[0]-veca[1]*veca[1]+veca[2]*veca[2])/(veca[0]*veca[0]+veca[1]*veca[1]+veca[2]*veca[2]))
  )
  console.error(
    'b',
    180/Math.PI*Math.acos((vecb[0]*vecb[0]-vecb[1]*vecb[1]+vecb[2]*vecb[2])/(vecb[0]*vecb[0]+vecb[1]*vecb[1]+vecb[2]*vecb[2]))
  )


  function edge(len,toa,iarc,oarc){
    var pi5 = Math.PI/5
    var tob=Math.PI*6/5-toa
    var ta=Math.PI-toa
    var tb=Math.PI-tob

    or=oarc/(Math.PI-2*tb)
    olen=or/Math.tan(tb)
    ir=iarc/(2*ta-Math.PI)
    ilen=-ir/Math.tan(ta)
    console.error(len,oarc,iarc,or,ir,ilen,olen)
    var totalLen=len+olen+ilen

    var rmax=1
    var rmin=1/(1/Math.tan(tb)+1/Math.tan(Math.PI-ta-tb))/Math.sin(Math.PI-ta-tb)
    var l=Math.sqrt(rmin*rmin+rmax*rmax-2*rmin*rmax*Math.cos(pi5))
    rmin*=totalLen/l
    rmax*=totalLen/l
    l*=totalLen/l
    var output=[];
    function step01(n){
      var arr=[];
      for(var i=0;i<=n;i++)arr.push(i/n)
      return arr;
    }
    for(var i=0;i<5;i++){
      var t0=(2*i+0)*pi5,t1=(2*i+1)*pi5,t2=(2*i+2)*pi5,t3=(2*i+3)*pi5
      var x0=rmax*Math.cos(t0), y0=rmax*Math.sin(t0)
      var x1=rmin*Math.cos(t1), y1=rmin*Math.sin(t1)
      var x2=rmax*Math.cos(t2), y2=rmax*Math.sin(t2)
      var x3=rmin*Math.cos(t3), y3=rmin*Math.sin(t3)
      var arc1={rr: rmax-olen/Math.cos(tb), r: or, rad: Math.PI/2-tb}
      var arc2={rr: rmin-ilen/Math.cos(ta), r: ir, rad: Math.PI/2-ta}
      svg.curve(step01(10).map(function(t){
        return {
          x:arc1.rr*Math.cos(t0)+or*Math.cos(t0+arc1.rad*(2*t-1)),
          y:arc1.rr*Math.sin(t0)+or*Math.sin(t0+arc1.rad*(2*t-1))
        }
      }))
      var line1, line2;
      svg.line(line1=[
        {x: x0*ilen/l+x1*(l-ilen)/l, y: y0*ilen/l+y1*(l-ilen)/l},
        {x: x1*olen/l+x0*(l-olen)/l, y: y1*olen/l+y0*(l-olen)/l}
      ])
      svg.curve([0,1,2,3,4,5,6,7,8,9,10].map(function(i){
        var t=i/10;
        return {
          x:arc2.rr*Math.cos(t1)-ir*Math.cos(t1-arc2.rad*(2*t-1)),
          y:arc2.rr*Math.sin(t1)-ir*Math.sin(t1-arc2.rad*(2*t-1))
        }
      }))
      svg.line(line2=[
        {x: x2*ilen/l+x1*(l-ilen)/l, y: y2*ilen/l+y1*(l-ilen)/l},
        {x: x1*olen/l+x2*(l-olen)/l, y: y1*olen/l+y2*(l-olen)/l}
      ])
      output.push({
        line1: line1,
        line2: line2,
        arc1: arc1,
        arc2: arc2
      })
    }
    return output
  }

  // var points=[];
  // for(var i=0;i<5;i++){
  //   var cos=-Math.cos(2*Math.PI*i/5);
  //   var sin=Math.sin(2*Math.PI*i/5);
  //   var sc=size/Math.cos(Math.PI/5);
  //   points.push({x:cos*sc,y:sin*sc});
  // }
  // svg.line(points,true);
  // var r0=size;
  // var r1=size/2;
  // var r2=size/2;
  // var theta1=Math.PI*25/180;
  // var theta2=Math.PI*50/180;
  // var len0=size*Math.tan(Math.PI/5);
  // var len1=len0+r1*Math.cos(theta1)*Math.tan(Math.PI/5)
  // var len2=len1+r2*Math.cos(theta2)*Math.tan(Math.PI/5)
  //
  // function rotline(line,flag,flip,method){
  //   if(!method)method='line';
  //   for(var i=0;i<5;i++){
  //     var c=Math.cos(2*Math.PI*i/5);
  //     var s=Math.sin(2*Math.PI*i/5);
  //     var l2=line.map(function(p){return{x:p.x*c-p.y*s,y:p.x*s+p.y*c};})
  //     svg[method](l2,flag);
  //     if(flip){
  //       var l2=line.map(function(p){return{x:p.x*c+p.y*s,y:p.x*s-p.y*c};})
  //       svg[method](l2,flag);
  //     }
  //   }
  // }
  //
  //
  // rotline([
  //   {x:r0,y:len0},
  //   {x:r0+r1,y:len1},
  //   {x:r0+r1,y:-len1},
  //   {x:r0,y:-len0},
  // ])
  // var qdx=1,qdy=(len2-len1)/r2;
  // var qdr=Math.sqrt(qdx*qdx+qdy*qdy);
  // qdx/=qdr;qdy/=qdr;
  // rotline([
  //   {x:r0+r1,y:len1},
  //   {x:r0+r1+r2,y:len2}],false,true);
  // rotline([
  //   {x:r0+r1+r2,y:len2},
  //   {x:r0+r1+r2+len2*qdy/qdx,y:0},
  //   {x:r0+r1+r2,y:-len2},
  // ],false,false,'curve')
  //
  // function square(x,y,dx,dy,L){
  //   var dr=Math.sqrt(dx*dx+dy*dy)
  //   dx/=dr;dy/=dr;
  //   var W=svg.lineWidth;
  //   rotline([
  //     {x:x-dx*(L/2-W)+dy*(T/2-W),y:y-dy*(L/2-W)-dx*(T/2-W)},
  //     {x:x-dx*(L/2-W)-dy*(T/2-W),y:y-dy*(L/2-W)+dx*(T/2-W)},
  //     {x:x+dx*(L/2-W)-dy*(T/2-W),y:y+dy*(L/2-W)+dx*(T/2-W)},
  //     {x:x+dx*(L/2-W)+dy*(T/2-W),y:y+dy*(L/2-W)-dx*(T/2-W)}
  //     ],true,true
  //   )
  // }
  // var L=5*scale
  // var y=len0-L-T-T/2;
  // var sq0,sq1,sq2,sq3
  // square(sq0=r0-L/2-T,y,1,0,L)
  // square(sq1=r0+r1/2,y,1,0,L)
  // square(sq2=r0+r1+T+L/2,y,1,0,L)
  //
  // var HOGE=0.67
  // var PIYO=0.27
  //
  // square(sq3=r0+r1+r0*HOGE+L/2,y,1,0,L)
  //
  // var qx=r0+r1+r2*PIYO
  // var qy=len1+(len2-len1)*PIYO
  // var qlen=(qy-y)/qdx-L/2;
  // var QL=L*2;
  // square(qx+qdy*qlen,qy-qdx*qlen,qdy,-qdx,QL);
  //
  // var d0=T*Math.tan(theta1/2)
  // var d1=T*Math.tan((theta2-theta1)/2)
  // var c1=Math.cos(theta1);
  // var s1=Math.sin(theta1);
  // var c2=Math.cos(theta2);
  // var s2=Math.sin(theta2);
  //
  //
  // svg.trans.x=103*scale;
  // svg.trans.y=2*scale
  // for(var i=0;i<10;i++){
  //   svg.trans.y+=8*scale
  //   svg.trans.x-=3.5*scale
  //   if(i==5){
  //     svg.trans.x=106*scale
  //     svg.trans.y=69*scale
  //     console.log(svg.trans)
  //   }
  //   svg.line([
  //     {x:0,y:0},
  //     {x:T,y:0},
  //     {x:T,y:T},
  //     {x:T+L,y:T},
  //     {x:T+L,y:0},
  //     {x:ax1=T+L/2+(r0-sq0)+d0,y:ay1=0},
  //     {x:(sx1=ax1+c1*(sq1-r0+d0))-c1*L/2,y:(sy1=ay1+s1*(sq1-r0+d0))-s1*L/2},
  //     {x:sx1-c1*L/2-s1*T,y:sy1-s1*L/2+c1*T},
  //     {x:sx1+c1*L/2-s1*T,y:sy1+s1*L/2+c1*T},
  //     {x:sx1+c1*L/2,y:sy1+s1*L/2},
  //     {x:(ax2=ax1+c1*(r1+d0+d1)),y:(ay2=ay1+s1*(r1+d0+d1))},
  //     {x:(sx2=ax2+c2*(sq2-r1-r0+d1))-c2*L/2,y:(sy2=ay2+s2*(sq2-r1-r0+d1))-s2*L/2},
  //     {x:sx2-c2*L/2-s2*T,y:sy2-s2*L/2+c2*T},
  //     {x:sx2+c2*L/2-s2*T,y:sy2+s2*L/2+c2*T},
  //     {x:sx2+c2*L/2,y:sy2+s2*L/2},
  //     {x:(sx3=ax2+c2*(sq3-r1-r0+d1))-c2*L/2,y:(sy3=ay2+s2*(sq3-r1-r0+d1))-s2*L/2},
  //     {x:sx3-c2*L/2-s2*T,y:sy3-s2*L/2+c2*T},
  //     {x:sx3+c2*L/2-s2*T,y:sy3+s2*L/2+c2*T},
  //     {x:sx3+c2*L/2,y:sy3+s2*L/2},
  //     {x:xe=sx3+c2*(L/2+T),y:ye=sy3+s2*(L/2+T)},
  //   ])
  //   svg.curve([
  //     {x:0,y:0},{x:r1/4,y:-L/2},{x:r1*3/4,y:-L/2},{x:r1,y:-L}
  //   ])
  //   svg.curve([
  //     {x:r1+L,y:-L},{x:r1+L+L/3,y:-L/3},{x:r1+2*L,y:L/3},{x:xe-L,y:ye-2*L},{x:xe,y:ye}
  //   ])
  //   svg.line([{x:r1,y:-L},{x:r1+L,y:-L}])
  // }
  //
  // var vecq={x:0,y:-Math.sin(theta2),z:Math.cos(theta2)};
  // var c5=Math.cos(2*Math.PI/5),s5=Math.sin(2*Math.PI/5);
  // var vecq2={x:c5*vecq.x-s5*vecq.y,y:c5*vecq.y+s5*vecq.x,z:vecq.z};
  // var dot=vecq.x*vecq2.x+vecq.y*vecq2.y+vecq.z*vecq2.z;
  // var thetaq=Math.acos(dot);
  // var dq=T*Math.tan(thetaq/2);
  //
  // svg.trans.x=96*scale
  // svg.trans.y=100*scale
  // for(var i=0;i<5;i++){
  //   svg.trans.y+=6.5*scale
  //   var cq=Math.cos(thetaq/2),sq=Math.sin(thetaq/2);
  //   svg.line([
  //     {x:-cq*(dq+qlen+QL/2-L),y:sq*(dq+qlen+QL/2-L)},
  //     {x:-cq*(dq+qlen+QL/2),y:sq*(dq+qlen+QL/2)},
  //     {x:-cq*(dq+qlen+QL/2)+sq*T,y:sq*(dq+qlen+QL/2)+cq*T},
  //     {x:-cq*(dq+qlen-QL/2)+sq*T,y:sq*(dq+qlen-QL/2)+cq*T},
  //     {x:-cq*(dq+qlen-QL/2),y:sq*(dq+qlen-QL/2)},
  //     {x:0,y:0},
  //     {x:cq*(dq+qlen-QL/2),y:sq*(dq+qlen-QL/2)},
  //     {x:cq*(dq+qlen-QL/2)-sq*T,y:sq*(dq+qlen-QL/2)+cq*T},
  //     {x:cq*(dq+qlen+QL/2)-sq*T,y:sq*(dq+qlen+QL/2)+cq*T},
  //     {x:cq*(dq+qlen+QL/2),y:sq*(dq+qlen+QL/2)},
  //     {x:xe=cq*(dq+qlen+QL/2-L),y:ye=sq*(dq+qlen+QL/2-L)},
  //   ]);
  //   svg.curve([
  //     {x:xe,y:ye},
  //     {x:0,y:-T},
  //     {x:-xe,y:ye}
  //   ])
  // }

  var img=new Image();
  img.src=svg.toDataURL();
  img.style.border='1px solid red'
  document.body.appendChild(img);
}
</script>
<style>
.floating{
  position: fixed;right:0;top:0;
  background:gray;
  opacity:0.9;
}
.floating input{margin-bottom:4px;}
</style>
<span></span>
<button onclick='regenerate()'>regenerate</button><br>
